$(document).ready(function(){$(".js-example-basic-multiple").select2({width:"resolve"}),$(".custom-option-group").each(function(){$(this).find(".custom-option-icon").on("click",function(){$(".custom-option-icon").removeClass("checked"),$(this).addClass("checked")})});var t=document.getElementById("totalBarcode"),e=document.getElementById("barcodeValue");function a(t){var e,a,i=t.data("bs-original-title");console.log(i),e=i,a=t,navigator.clipboard.writeText(e),$(a).after('<span class="text-danger" style="margin-left: 5px; font-size: 10px;">Copied!</span>'),setTimeout(function(){$(a).next("span").remove()},1500)}function i(t,e,a,i,d,n,l){let o=$("#linkDesModal .modal-body");o.empty(),o.addClass("row").addClass("text-center");let r=$("<h4></h4>").text(l).addClass("text-center text-danger"),s=$("<h5></h5>").text(e.product_template_width+"x"+e.product_template_height).addClass("text-center");o.append(r),o.append(s);let c;if(1===t.length?c="col-12 mb-3":t.length%3==0?c="col-md-4 mb-3":(t.length,c="col-md-3 mb-3"),a?t.forEach(function(t){let e;if(t.link.toLowerCase().endsWith(".pdf")){e=$("<div></div>");let a=$("<div></div>").addClass("pdf-embed-container"),i=$("<embed>").attr("src",t.link).attr("type","application/pdf").addClass("pdf-embed");a.append(i),e.append(a)}else{e=$("<div></div>").addClass(c);let d=$("<img>").attr("src",t.link).addClass("img-fluid modal-image").css("box-shadow","0 2px 20px 0 rgba(67,89,113,.45)"),n=$("<small></small>").text(t.width+"x"+t.height+" px").addClass("text-muted"),l=$("<small></small>").text(t.width_mm+"x"+t.height_mm+" mm").addClass("text-muted"),r=$("<small></small>").text(t.width_inch+"x"+t.height_inch+" inch").addClass("text-muted"),s=t.link.split("/").pop(),u=$("<small></small>").text(s).addClass("text-muted"),p=$('<a target="_blank"></a>').attr({href:t.link,download:s}).addClass("download-link").append(d);e.append(p).append("<hr>").append(n),e.append(p).append(l).append("<br>").append(r).append(u).append("<hr>")}o.append(e)}):t.forEach(function(t){let e;if(t.link.toLowerCase().endsWith(".pdf")){e=$("<div></div>");let a=$("<div></div>").addClass("pdf-embed-container"),i=$("<embed>").attr("src",t.link).attr("type","application/pdf").addClass("pdf-embed");a.append(i),e.append(a)}else{e=$("<div></div>").addClass(c);let d=$("<img>").attr("src",t.link).addClass("img-fluid modal-image").css("box-shadow","0 2px 20px 0 rgba(67,89,113,.45)"),n=t.link.split("/").pop(),l=$("<small></small>").text(t.width_mm+"x"+t.height_mm+" mm").addClass("text-muted"),r=$("<small></small>").text(n).addClass("text-muted"),s=$('<a target="_blank"></a>').attr({href:t.link,download:n}).addClass("download-link").append(d);e.append(s).append("<hr>").append(l),e.append(s).append(r).append("<br>").append("<hr>")}o.append(e)}),n){let u=`
            <div class="text-center mt-3">
                <button type="button" class="btn btn-primary" data-order-id="${a}" data-product-id="${i}" data-lineitem-id="${d}" id="approve">Approve</button>
                <button type="button" class="btn btn-danger" data-order-id="${a}" data-product-id="${i}" data-lineitem-id="${d}" id="reject">Reject</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        `;o.append(u)}$("#linkDesModal").modal("show")}function d(t,e,a,i){$.ajax({url:"/api/get_image_info",type:"POST",data:JSON.stringify({link:t,product_type:e}),success:a,error:i})}t&&(t.oninput=function(){e.innerHTML=this.value}),$('[data-toggle="tooltip"]').tooltip(),$(".personalization").on("click",function(){a($(this))}),$(".bx-note").on("click",function(){a($(this))}),$("#printBarcodeButton").on("click",function(t){t.preventDefault();!function t(e){let a=$("#table_products").find('td:first-child input[type="checkbox"]:checked'),i=[];if(a.each(function(){let t=$(this).data("order-id"),a=$(this).data("customer"),d=$(this).data("seller-id");i.push({orderId:t,name:a,seller_id:d,totalBarcode:e})}),a.length<1)return alert("Please select at least 1 order"),!1;$.ajax({url:"/api/get_barcode_data",type:"POST",data:JSON.stringify({selectedValues:i}),success:function(t){var e,a;e=t,a=window.open("","","width=600,height=400"),e.barcodeData.forEach(function(t,i){var d=document.createElement("div");d.className="barcode-container";var n=document.createElement("div");n.innerHTML=t.barcodeSvg,d.appendChild(n),a.document.body.appendChild(d),html2canvas(d).then(function(t){if(d.innerHTML="",d.appendChild(t),i<e.barcodeData.length-1){var a=document.createElement("div");a.style.pageBreakAfter="always",d.appendChild(a)}d.classList.add("print")})}),html2canvas(a.document.body).then(function(t){a.document.body.innerHTML="",a.document.body.appendChild(t),a.print()})},error:function(t){console.log("error",t)}})}($("#totalBarcode").val())}),$('[data-toggle="tooltip"]').tooltip();var n=$("#table_products").DataTable({select:{style:"multi",selector:'td:first-child input[type="checkbox"]'},aLengthMenu:[[25,50,100,200,-1],[25,50,100,200,"All"]],paging:!1,iDisplayLength:-1,fixedHeader:!0,columnDefs:[{targets:"_all",width:"50px"}],autoWidth:!0});function l(t,e,a,i,d){$.ajax({url:"/api/change_order_status",type:"POST",data:JSON.stringify({orderId:t,productId:e,status:a,note:i}),contentType:"application/json",success:function(t){var e,i;alert(t.message),200===t.status&&(e=d,i=a,e.attr("data-status",i),e.css("background-color",{Ready:"#ecc3fc",Done:"#c5ffd8","Done recently":"#a3ff96",In:"#b3d0ff",Out:"#f8fca3",Cancel:"#ff8c8c",Doing:"#ffdc97","FF Ngoai":"#d6d6d6","Sai design":"#ffbd38","Rejected":"#ffbd38","Design uploaded":"#ffa6e0"}[i]||"transparent"))},error:function(t){console.log(t),alert(t)}})}function o(t,e){let a=$("#table_products").find('td:first-child input[type="checkbox"]:checked');a.length<1&&(a=$("#table_products_api").find('td:first-child input[type="checkbox"]:checked'));let i=[];if(a.each(function(){let t=$(this).data("order-id"),e=$(this).data("product-id");i.push({orderId:t,productId:e})}),a.length<1)return alert("Please select at least 1 order"),!1;$.ajax({url:t,type:"POST",data:JSON.stringify({selectedValues:i}),xhrFields:{responseType:"blob"},success:function(t){let a=URL.createObjectURL(t),i=document.createElement("a");i.style.display="none",i.href=a,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i)},error:function(t){console.log("error",t)}})}$(".column-toggle").each(function(){let t=n.column($(this).data("column"));$(this).is(":checked")||t.visible(!1)}),$(".column-toggle").on("change",function(){let t=n.column($(this).data("column")),e=$(".column-filters").data("user"),a=[];$(".column-toggle").each(function(){$(this).is(":checked")&&a.push($(this).data("column"))}),t.visible(!t.visible()),$.ajax({url:"/api/table_column",type:"POST",data:JSON.stringify({column:a,user:e}),success:function(t){},error:function(t){}})}),$(".popup_img").magnificPopup({type:"image"}),$("#table_products").on("change",".status-select",function(){let t=$(this).val(),e=$(this).data("order-id"),a=$(this).data("product-id"),i=$(this).data("link-des"),d=$(this).data("product-type"),n=$(this).data("sku"),o=$(this).closest(".order-row");confirm("Are you sure?")&&("Sai design"===t?($("#noteModal").modal("show"),$("#noteModal").one("click","#submitNote",function(){let i=$("#noteInput").val();l(e,a,t,i,o),$("#noteInput").val(""),$("#noteModal").modal("hide")})):"Ready"===t&&(null==i||""===i)?(console.log("request to server to get link des"),$.ajax({url:"/api/get_link_des",type:"POST",data:JSON.stringify({sku:n}),success:function(i){if(200===i.status){if(null===i.link_des)$("#uploadOrderDesignReuse").modal("show");else{l(e,a,t,null,o);let r=JSON.stringify(i.link_des).replace(/"/g,"'").replace(/','/g,"', '");html=`
                                    <button type="button"
                                        class="btn btn-sm rounded-pill btn-label-primary download-btn"
                                        data-order-id="${e}" data-product-id="${a}" data-link="${r}"
                                        data-product-type="${d}">
                                        <i class="tf-icons bx bx-download"></i>
                                    </button>
                                `,o.find(".link-des").html(html)}}else uploadOrderDesignReuse(e,a,n)},error:function(i){console.log("error",i),l(e,a,t,null,o)}})):l(e,a,t,null,o))}),$("#table_products").on("change",".factory-select",function(){var t=$(this).val(),e=$(this).attr("data-order-id"),a=$(this).attr("data-product-id");confirm("Are you sure?")&&$.ajax({url:"/api/change_order_factory",type:"POST",data:JSON.stringify({orderId:e,productId:a,factory:t}),success:function(t){alert(t.message)},error:function(t){alert("Error: ",t)}})}),$("#table_products").on("click",".delete-product",function(){var t=$(this).data("id");confirm("Are you sure?")&&$.ajax({url:"/api/delete_product",type:"POST",data:JSON.stringify({id:t,type:"fulfillment"}),success:function(t){alert("Product deleted successfully"),window.location.reload()},error:function(t){alert("Error deleting product")}})}),$("#table_products").on("click","#check-all",function(){var t=$(this).prop("checked");$(".order-row input[type='checkbox']").prop("checked",t)}),$("#table_products").on("click",".check-btn",function(){let t=$(this),e=t.data("product-id"),a=t.data("order-id"),n=t.data("lineitem-id"),l=t.data("link"),o=t.data("product-type");d(l,o,function(t){let d=t.images,l=t.template;i(d,l,a,e,n,!0,a)},function(t){console.error(t)})}),$("#table_products").on("click",".download-btn",function(){let t=$(this),e=t.data("link"),a=t.data("product-type"),n=t.data("order-id");d(e,a,function(t){let e=t.images;console.log(e);let a=t.template;i(e,a,null,null,null,!1,n)},function(t){console.error(t)})}),$("#table_products").on("click","#archive",function(){let t=$("#table_products").find('td:first-child input[type="checkbox"]:checked');t.length<1&&(t=$("#table_products_api").find('td:first-child input[type="checkbox"]:checked'));let e=[];t.each(function(){let t=$(this).data("lineitem-id");e.push({lineItemId:t})}),$.ajax({url:"/api/archive_order",type:"POST",data:JSON.stringify({selectedValues:e}),success:function(t){alert("Order archived successfully"),window.location.reload()},error:function(t){console.log("error",t)}})}),$("#assignDes").on("click",function(){$.ajax({url:"/api/search_designer",type:"POST",success:function(t){var e;let a=t.designers;$("#assignDesInput").typeahead({hint:!0,highlight:!0,minLength:1},{name:"designers",source:(e=a,function t(a,i){var d,n;d=[],n=RegExp(a,"i"),$.each(e,function(t,e){n.test(e)&&d.push(e)}),i(d)})})},error:function(t){console.log("error",t)}})}),$("#assignBtn").on("click",function(){let t=$("#assignDesInput").val(),e=$("#table_products").find('td:first-child input[type="checkbox"]:checked');e.length<1&&(e=$("#table_products_api").find('td:first-child input[type="checkbox"]:checked'));if(!$("#assignDesInput").data("designer").includes(t))return alert("Please enter designer name in list"),!1;if(""===t)return alert("Please enter designer name"),!1;if(e.length<1)return alert("Please select at least 1 order"),!1;let a=[];e.each(function(){let t=$(this).data("order-id"),e=$(this).data("product-id"),i=$(this).data("lineitem-id");a.push({orderId:t,productId:e,lineItemId:i})}),$.ajax({url:"/api/assign_designer",type:"POST",data:JSON.stringify({selectedValues:a,designer:t}),success:function(t){if(200!==t.status)return alert(t.message),!1;alert("Order assigned successfully"),e.each(function(){let t=$(this).closest(".order-row");t.find(".status-select").val("Designing"),t.attr("data-status","Designing"),t.css("background-color","#95c3c7")}),$("#assignDesModal").modal("hide")},error:function(t){console.log("error",t)}})}),$("#linkDesModal").on("click","#approve",function(){let t=$(this),e=t.data("product-id"),a=t.data("order-id"),i=t.data("lineitem-id");$.ajax({url:"/api/approve_designer",type:"POST",data:JSON.stringify({product_id:e,order_id:a,line_item_id:i}),success:function(t){let d=$(`.order-row[data-order-id="${a}"][data-product-id="${e}"][data-lineitem-id="${i}"]`);d.find(".status-select").val("Ready"),d.attr("data-status","Ready"),alert("Approved successfully"),$("#linkDesModal").modal("hide")},error:function(t){console.error(t)}})}),$("#linkDesModal").on("click","#reject",function(){let t=$(this),e=t.data("product-id"),a=t.data("order-id"),i=t.data("lineitem-id");$("#linkDesModal").modal("hide"),$("#noteModal").modal("show"),$("#noteModal").one("click","#submitNote",function(){let t=$("#noteInput").val();$.ajax({url:"/api/reject_designer",type:"POST",data:JSON.stringify({product_id:e,order_id:a,line_item_id:i,note:t}),success:function(t){let d=$(`.order-row[data-order-id="${a}"][data-product-id="${e}"][data-lineitem-id="${i}"]`);d.find(".status-select").val("Rejected"),d.attr("data-status","Rejected"),alert("Rejected successfully"),$("#noteModal").modal("hide")},error:function(t){console.error(t)}})})}),$("#filter-order").on("submit",function(t){t.preventDefault();let e=$("#date-range-picker-2").val(),a=$("#filter_status").val(),i=$("#filter_factory").val(),d=$("#filter_designer").val(),n=$("#filter_shop").val(),l=$("#filter_team").val(),o=$("#filter_type").val(),r=$("#filter_seller").val(),s=$("#filter_order_id").val(),c=$("#filter_tracking_synced").val(),u=$("#filter_have_tracking").val(),p=$("#filter_shipping_day").length>0?$("#filter_shipping_day").val():null;$("#filter_ff_provider").length>0&&$("#filter_ff_provider").val(),$(".loading_spinner").show(),$(".render-results").hide();let f=document.getElementsByTagName("script"),h=!1;for(let g=0;g<f.length;g++){let m=f[g].getAttribute("src");if(m&&m.includes("new_orders.min.js")){h=!0;break}}window.location.pathname;let b=function t(e){let a=new URL(window.location.href),i=a.searchParams;for(let d of i.keys())i.delete(d);for(let[n,l]of Object.entries(e))null!=l&&i.set(n,l);return a.href}({date:e,status:a,factory:i,designer:d,shop:n,team:l,type:o,seller:r,order_id:s,shipping_day:p,tracking_synced:c,have_tracking:u});window.location=b}),$("#importTracking").on("click",function(){var t=$("#file")[0].files[0],e=new FormData;e.append("file",t),$.ajax({url:"/api/import_trackings",method:"POST",data:e,contentType:!1,processData:!1,success:function(t){"success"===t.status?(alert("Import tracking successfully"),$("#importTrackingModal").modal("hide")):(alert("Import tracking failed"),$("#importTrackingModal").modal("hide"))},error:function(){alert("An error occurred while processing the request"),$("#importTrackingModal").modal("hide")}})}),$("#submitBulkEdit").on("click",function(){let t=$("#table_products").find('td:first-child input[type="checkbox"]:checked');t.length<1&&(t=$("#table_products_api").find('td:first-child input[type="checkbox"]:checked'));let e=[];if(t.each(function(){let t=$(this).data("order-id"),a=$(this).data("product-id");e.push({orderId:t,productId:a})}),t.length<1)return alert("Please select at least 1 order"),!1;let a=$(".nav-link-2.active").data("bs-target"),i;if("#navs-top-xuong"===a?i=$("#bulk_factory").val():"#navs-top-status"===a?i=$("#bulk_status").val():"#navs-top-type"===a&&(i=$("#bulk_type").val()),""===i)return alert("Please select value"),!1;$.ajax({url:"/api/bulk_edit",type:"POST",data:JSON.stringify({selectedValues:e,[a.substring(1)]:i}),success:function(t){alert(t.message),$("#bulkEditModal").modal("hide"),window.location.reload()},error:function(t){console.log("error",t)}})}),$("#submitReplace").on("click",function(){let t=$("#table_products").find('td:first-child input[type="checkbox"]:checked');t.length<1&&(t=$("#table_products_api").find('td:first-child input[type="checkbox"]:checked'));let e=[];if(t.each(function(){let t=$(this).data("order-id"),a=$(this).data("lineitem-id");e.push({orderId:t,lineItemId:a})}),t.length<1)return alert("Please select at least 1 order"),!1;let a=$("#replaceInput").val();$.ajax({url:"/api/replace_items",type:"POST",data:JSON.stringify({selectedValues:e,reason:a}),success:function(t){alert(t.message),window.location.reload()},error:function(t){console.log("error",t)}})}),$(".copy-id").click(function(){var t=$(this).data("order-id"),e=$(this).data("name"),a=$("<input>");$("body").append(a),a.val(t+" - "+e).select(),document.execCommand("copy"),a.remove();var i=this;$(i).after('<span class="text-danger" style="margin-left: 5px; font-size: 10px;">Copied!</span>'),setTimeout(function(){$(i).next("span").remove()},1500)}),$("#kiotviet").on("click",function(){o("/api/kiotviet","kiotviet.xlsx")}),$("#export_xuong").on("click",function(){o("/api/export_xuong","export_xuong.xlsx")}),$("#export_ship").on("click",function(){o("/api/export_ship","export_ship.xlsx")}),$("#sync_tracking").on("click",function(){let t=$("#table_products").find('td:first-child input[type="checkbox"]:checked');t.length<1&&(t=$("#table_products_api").find('td:first-child input[type="checkbox"]:checked'));let e=[];if(t.each(function(){let t=$(this).data("order-id"),a=$(this).data("lineitem-id");e.push({orderId:t,lineItemId:a})}),t.length<1)return alert("Please select at least 1 order"),!1;$.ajax({url:"/api/sync_tracking",type:"POST",data:JSON.stringify({selectedValues:e}),success:function(t){alert(t.message),window.location.reload()},error:function(t){alert("Error: ",t),console.log("error",t)}})}),$("#export_flast_ship").on("click",function(){o("/api/export_flast_ship","export_flast_ship.csv")}),$("#table_products").on("click",".editable",function(){$(this).attr("contentEditable",!0),$(this).find(".limited-text").removeClass("limited-text")}),$("#table_products").on("click",".editable-select",function(){$(this).find("select").prop("disabled",!1)}),$("#table_products").on("blur",".editable",async function(){let t=$(this).text(),e=$(this).data("order-id"),a=$(this).data("lineitem-id"),i=$(this).attr("data-field");try{let d=await $.ajax({url:"/api/change_product_field",type:"POST",data:JSON.stringify({orderId:e,lineItemId:a,field:i,value:t})});console.log(d.message)}catch(n){console.log(n)}}),$("#table_products").on("change",".editable-select select",function(){let t=$(this).val(),e=$(this).closest(".editable-select").data("order-id"),a=$(this).closest(".editable-select").data("lineitem-id"),i=$(this).parent().attr("data-field");$.ajax({url:"/api/change_product_field",type:"POST",data:JSON.stringify({orderId:e,lineItemId:a,field:i,value:t}),success:function(t){if("product_type"===i){let d=$(`.order-row[data-order-id="${e}"][data-lineitem-id="${a}"]`);d.find(".factory-select").val(t.xuong),null!==t.ff_status&&(d.find(".status-select").val(t.ff_status),d.attr("data-status",t.ff_status))}console.log(t.message)},error:function(t){console.log(t)}})}),$(".bs-rangepicker-single").each(function(){let t=$(this).data("value"),e={singleDatePicker:!0,opens:"left",autoUpdateInput:!1,locale:{format:"DD/MM/YYYY"}};void 0!==t&&""!==t&&(e.startDate=moment(t,"DD/MM/YYYY"),$(this).val(e.startDate.format("DD/MM/YYYY"))),$(this).daterangepicker(e),$(this).on("apply.daterangepicker",function(t,e){$(this).val(e.startDate.format("DD/MM/YYYY"));let a=$(this).val(),i=$(this).closest(".editable-date").data("order-id"),d=$(this).closest(".editable-date").data("lineitem-id"),n=$(this).closest(".editable-date").data("field");$.ajax({url:"/api/change_product_field",type:"POST",data:JSON.stringify({orderId:i,lineItemId:d,field:n,value:a}),success:function(t){console.log(t.message)},error:function(t){console.log(t)}})}),$(this).on("cancel.daterangepicker",function(t,e){$(this).val("")})}),$("#table_products").on("click",".order-history",function(t){t.preventDefault();var e=$(this).data("order-id"),a=$(this).data("lineitem-id");$.ajax({url:"/api/get_order_history",type:"POST",data:JSON.stringify({orderId:e,lineItemId:a}),contentType:"application/json",success:function(t){var e="";console.log(t.result.length);for(var a=0;a<t.result.length;a++)console.log(t.result[a]),e+=`
                    <li class="timeline-item timeline-item-transparent">
                        <span class="timeline-point-wrapper"><span class="timeline-point timeline-point-primary"></span></span>
                        <div class="timeline-event">
                            <div class="timeline-header border-bottom mb-3">
                                <h6 class="mb-0">${t.result[a]}</h6>
                            </div>
                        </div>
                    </li>
                    `;console.log(e),$("#historyModal .timeline").html(e),$("#historyModal").modal("show")},error:function(t){console.log("error",t)}})}),setInterval(()=>{$.ajax({url:"/api/set_statistics",type:"POST",success:function(t){try{$("#total_ready").text(t.data.total_ready),$("#total_confirming").text(t.data.total_confirming),$("#total_pending").text(t.data.total_pending),$("#total_doing").text(t.data.total_doing),$("#total_sai_des").text(t.data.total_sai_design),$("#total_design_uploaded").text(t.data.total_design_uploaded),$("#total_in").text(t.data.total_in),$("#total_out").text(t.data.total_out),$("#total_half_done").text(t.data.total_half_done),$("#total_designing").text(t.data.total_designing),$("#total_ready_7").text(t.data.total_ready_7),$("#total_none").text(t.data.total_none)}catch(e){console.log(e)}},error:function(t){console.log("error",t)}})},5e3)});